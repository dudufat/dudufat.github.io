= AP排查问题技术总结
haodongdong
:toc:
:toclevels: 4
:toc-position: left
:source-highlighter: pygments
:icons: font
:sectnums:

== PING包不通问题

TIP: AP 不通问题要跟据实际情况实际排查，文中思路只是经验排查

* 常见排除原因
** 查看网口状态，是否是正常UP/RUNNING状态
** 检查协商速率，是否正常。通常，百兆网口的AP直接连接千兆口设备比如AC，会出现不通，需要用千兆POE或者交换机中转一下.
** 单通情况，首先排除电脑端的防火墙设置，由于各种防火墙存在，以及杀毒软件，可能导致单通情况。关闭后，依然出现单通，检查AP上配置是否有 +
   filter配置。检查命令如下： 
*** iptables -L
*** ebtales -L
*** 清除命令：iptables -F
** 以上情况都排除以后，只有抓包来确认报文不通位置
***  *ap上抓包有接收到报文和响应报文，PC上没有收到*
**** 确认转发状态设置正常 'cat /proc/sys/net/ipv4/ip_forward' 是否为1，如果不等于1，则置1
**** 'cat /sys/class/net/eth0/statistics/tx_bytes/rx_bytes' 查看状态，确认流量正常，PC端抓包，排除AP驱动问题.
** 其他手段

== AP重启问题排查总结

=== 重启种类

TIP: 重启种类：正常重启和异常重启，本文主要讨论异常重启 

. 异常重启：
.. 用户层异常调用reboot，这种重启AP会记录重启原因，一般根据重启原因找到相对应的代码块位置即可找到问题，解决问题
.. 内核态重启：看门狗重启和堆栈重启

=== 异常重启分析
==== 用户层导致重启
* 看reboot重启原因，根据原因打印找到相对应代码模块
* 看LOG打印，根据LOG打印，可以定位到相应的模块
* 其他方法

==== 内核态重启
===== 看门狗重启
* 看门狗原理介绍
** 简单介绍

Linux 自带了一个 watchdog 的实现，用于监视系统的运行，包括一个内核 watchdog module 和一个用户空间的 watchdog 程序。内核 watchdog 模块通过 /dev/watchdog 这个字符设备与用户空间通信。用户空间程序一旦打开 /dev/watchdog 设备（俗称“开门放狗”），就会导致在内核中启动一个1分钟的定时器（系统默认时间），此后，用户空间程序需要保证在1分钟之内向这个设备写入数据（俗称“定期喂狗”），每次写操作会导致重新设定定时器。如果用户空间程序在1分钟之内没有写操作，定时器到期会导致一次系统 reboot 操作（“狗咬人了”呵呵）。通过这种机制，我们可以保证系统核心进程大部分时间都处于运行状态，即使特定情形下进程崩溃，因无法正常定时“喂狗”，Linux系统在看门狗作用下重新启动（reboot），核心进程又运行起来了

** 详细原理介绍

请点击这里: link:http://ksffj6eu.blog.163.com/blog/static/9259276720087277487482/[看门狗原理介绍]

* 看门狗重启常见原因
** 大流量导致的CPU繁忙，没有多余精力调度喂狗进程，造成狗饿死，重启系统
** 死锁或者死循环造成的系统僵死，某个进程无限占用CPU，造成喂狗进程饿死，从而无法喂狗，重启

===== 堆栈重启


* 重启
** 看门狗重启
*** 判定依据：AP中看门狗重启
** 应用层异常调用重启命令
** 堆栈重启
*** 内存泄漏问题
*** double free问题
*** 空指针问题
*** 非法地址访问
*** 内存不足页表映射错误
*** 死锁
**** 死锁类型
*** 其它问题
* 堆栈问题排查思路总结
** 根据堆栈判断原因
** 根据堆栈定位模块
** 根据堆栈寄存器位置，利用OBJDUMP 反汇编找出堆栈位置
*** OBJDUMP使用方法

